{% extends "layouts/base.html" %}

{% block content %}
<div class="flex h-screen overflow-hidden">
    {% include "includes/admin_sidebar.html" %}

    <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-50 p-6">
        <h1 class="text-2xl font-bold text-gray-800 mb-6">Estad√≠sticas de Closers (Manual)</h1>

        <!-- Filter Bar -->
        <div class="bg-white p-4 rounded-lg shadow-sm mb-6">
            <form method="get" class="flex flex-wrap gap-4 items-end">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Closer</label>
                    <select name="closer_id" class="border-gray-300 rounded-md shadow-sm focus:ring-indigo-500">
                        <option value="">Todos</option>
                        {% for c in closers %}
                        <option value="{{ c.id }}" {% if selected_closer==c.id|string %}selected{% endif %}>{{
                            c.username }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Desde</label>
                    <input type="date" name="start_date" value="{{ start_date }}"
                        class="border-gray-300 rounded-md shadow-sm">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Hasta</label>
                    <input type="date" name="end_date" value="{{ end_date }}"
                        class="border-gray-300 rounded-md shadow-sm">
                </div>
                <button type="submit"
                    class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700">Filtrar</button>
            </form>
        </div>

        <!-- KPI Cards -->
        <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-8">
            <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-blue-500">
                <div class="text-xs text-gray-500 uppercase font-bold">Show Rate (1st)</div>
                <div class="text-2xl font-bold text-gray-800">{{ "%.1f"|format(kpis.show_rate_1) }}%</div>
                <div class="text-xs text-gray-400">{{ total.first_attended }} / {{ total.first_agendas }}</div>
            </div>
            <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-indigo-500">
                <div class="text-xs text-gray-500 uppercase font-bold">Show Rate (2nd)</div>
                <div class="text-2xl font-bold text-gray-800">{{ "%.1f"|format(kpis.show_rate_2) }}%</div>
                <div class="text-xs text-gray-400">{{ total.second_attended }} / {{ total.second_agendas }}</div>
            </div>
            <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-yellow-500">
                <div class="text-xs text-gray-500 uppercase font-bold">Offer Rate</div>
                <div class="text-2xl font-bold text-gray-800">{{ "%.1f"|format(kpis.offer_rate) }}%</div>
                <div class="text-xs text-gray-400">{{ total.presentations }} pres.</div>
            </div>
            <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-green-500">
                <div class="text-xs text-gray-500 uppercase font-bold">Closing Rate</div>
                <div class="text-2xl font-bold text-gray-800">{{ "%.1f"|format(kpis.closing_rate) }}%</div>
                <div class="text-xs text-gray-400">Sobre Presentaciones</div>
            </div>
            <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-purple-500">
                <div class="text-xs text-gray-500 uppercase font-bold">Ventas Totales</div>
                <div class="text-2xl font-bold text-gray-800">{{ kpis.total_sales }}</div>
                <div class="text-xs text-gray-400">Call + Followup</div>
            </div>
        </div>

        <!-- Detailed Table -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden overflow-x-auto">
            <table class="w-full text-left text-sm whitespace-nowrap">
                <thead class="bg-gray-50 border-b border-gray-200 text-gray-500 uppercase text-xs">
                    <tr>
                        <th class="px-4 py-3">Fecha</th>
                        <th class="px-4 py-3">Closer</th>
                        <th class="px-4 py-3 text-center bg-blue-50">1st Agda</th>
                        <th class="px-4 py-3 text-center bg-blue-50">1st Att</th>
                        <th class="px-4 py-3 text-center bg-yellow-50">Pres.</th>
                        <th class="px-4 py-3 text-center bg-green-50">Venta Call</th>
                        <th class="px-4 py-3 text-center bg-green-50">Venta Foll</th>
                        <th class="px-4 py-3 text-center">Self Gen</th>
                        <th class="px-4 py-3 text-center">Win</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-100">
                    {% for stat in stats %}
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-3 font-medium">{{ stat.date.strftime('%Y-%m-%d') }}</td>
                        <td class="px-4 py-3">{{ stat.closer.username }}</td>
                        <td class="px-4 py-3 text-center bg-blue-50/50">{{ stat.first_agendas }}</td>
                        <td class="px-4 py-3 text-center bg-blue-50/50 font-bold">{{ stat.first_agendas_attended }}</td>
                        <td class="px-4 py-3 text-center bg-yellow-50/50">{{ stat.presentations }}</td>
                        <td class="px-4 py-3 text-center bg-green-50/50 font-bold text-green-700">{{ stat.sales_on_call
                            }}</td>
                        <td class="px-4 py-3 text-center bg-green-50/50 text-green-700">{{ stat.sales_followup }}</td>
                        <td class="px-4 py-3 text-center">{{ stat.self_generated_bookings }}</td>
                        <td class="px-4 py-3 text-xs text-gray-500 truncate max-w-xs" title="{{ stat.win_of_day }}">{{
                            stat.win_of_day }}</td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="9" class="p-8 text-center text-gray-500">No hay reportes en este periodo.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </main>
</div>
{% endblock %}